<!--
@license
Copyright (c) 2017 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="polymon-element.html">
<link rel="import" href="polymon-styles.html">
<dom-module id="polymon-tournament-move-visualizer">
  <template>
    <style include="typography">
      @keyframes flash {
        0% {
          opacity: 0;
        }

        19.9% {
          opacity: 0;
        }

        20% {
          opacity: 0.75;
        }

        21.5% {
          opacity: 0;
        }

        24.9% {
          opacity: 0;
        }

        25% {
          opacity: 1;
        }

        34% {
          opacity: 0;
        }

        59.9% {
          opacity: 0;
        }

        60% {
          opacity: 1
        }

        65% {
          opacity: 0;
        }

        100% {
          opacity: 0;
        }
      }

      @keyframes attackOne {
        0% {
          transform: translate(200px, 200px);
        }

        20% {
          transform: translate(100px, 200px) scale(0.8);
        }

        20.1% {
          transform: translate(1000px, 0px) scale(-1.2, 1.2);
        }

        24.9% {
          transform: translate(1050px, -50px) scale(-1.2, 1.2);
        }

        25% {
          transform: translate(150px, 200px) scale(0.8);
        }

        80% {
          transform: translate(50px, 200px) scale(0.7);
        }

        82% {
          transform: translate(-600px, 200px) scale(0.7);
        }

        100% {
          transform: translate(-600px, 200px) scale(0.7);
        }
      }

      @keyframes attackTwo {
        0% {
          transform: translate(-200px, -400px);
        }

        20% {
          transform: translate(-100px, -400px) scale(0.8);
        }

        20.1% {
          transform: translate(-1000px, -200px) scale(-1.2, 1.2);
        }

        24.9% {
          transform: translate(-1050px, -150px) scale(-1.2, 1.2);
        }

        25% {
          transform: translate(-150px, -200px) scale(0.8);
        }

        80% {
          transform: translate(-50px, -200px) scale(0.7);
        }

        82% {
          transform: translate(600px, -200px) scale(0.7);
        }

        100% {
          transform: translate(600px, -200px) scale(0.7);
        }
      }

      @keyframes showStatOne {
        0% {
          transform: translate(-100px, -50px);
          opacity: 0;
        }

        20% {
          transform: translate(-100px, -50px);
          opacity: 0;
        }

        20.1% {
          transform: translate(-100px, -50px);
          opacity: 1;
        }

        80% {
          transform: translate(-400px, -50px);
          opacity: 1;
        }

        82% {
          transform: translate(-2500px, -50px);
          opacity: 1;
        }

        100% {
          transform: translate(-2320px, -50px);
          opacity: 1;
        }
      }

      @keyframes showStatTwo {
        0% {
          transform: translate(100px, 50px);
          opacity: 0;
        }

        20% {
          transform: translate(100px, 50px);
          opacity: 0;
        }

        20.1% {
          transform: translate(100px, 50px);
          opacity: 1;
        }

        80% {
          transform: translate(400px, 50px);
          opacity: 1;
        }

        82% {
          transform: translate(2500px, 50px);
          opacity: 1;
        }

        100% {
          transform: translate(2320px, 50px);
          opacity: 1;
        }
      }

      @keyframes revealValueOne {
        0% {
          transform: translateX(1920px);
        }

        25% {
          transform: translateX(1920px);
        }

        25.5% {
          transform: translateX(0);
        }

        80% {
          transform: translateX(0);
        }

        82% {
          transform: translateX(-2500px);
        }

        100% {
          transform: translateX(-2500px);
        }
      }

      @keyframes revealValueTwo {
        0% {
          transform: translateX(1920px);
        }

        25% {
          transform: translateX(1920px);
        }

        25.5% {
          transform: translateX(0);
        }

        80% {
          transform: translateX(0);
        }

        82% {
          transform: translateX(2500px);
        }

        100% {
          transform: translateX(2500px);
        }
      }

      @keyframes revealTotal1 {
        0% {
          transform: translateY(0);
          opacity: 1;
        }

        38% {
          transform: translateY(0);
          opacity: 1;
        }

        40% {
          transform: translateY(-10%) scale(1.25);
          opacity: 0;
        }

        100% {
          transform: translateY(-10%) scale(1.25);
          opacity: 0;
        }
      }

      @keyframes revealTotal2 {
        0% {
          transform: translateY(0);
          opacity: 0;
        }

        38% {
          transform: translateY(0);
          opacity: 0;
        }

        40% {
          opacity: 1;
          transform: translateY(0);
        }

        42% {
          transform: translateY(-10%) scale(1.25);
          opacity: 0;
        }

        100% {
          transform: translateY(-10%) scale(1.25);
          opacity: 0;
        }
      }

      @keyframes revealTotal3 {
        0% {
          transform: translateY(0);
          opacity: 0;
        }

        40% {
          transform: translateY(0);
          opacity: 0;
        }

        42% {
          opacity: 1;
          transform: translateY(0);
        }

        44% {
          transform: translateY(-10%) scale(1.25);
          opacity: 0;
        }

        100% {
          transform: translateY(-10%) scale(1.25);
          opacity: 0;
        }
      }

      @keyframes revealTotal4 {
        0% {
          transform: translateY(0);
          opacity: 0;
        }

        42% {
          transform: translateY(0);
          opacity: 0;
        }

        44% {
          transform: translateY(0);
          opacity: 1;
        }

        100% {
          transform: translateY(0);
          opacity: 1;
        }
      }

      @keyframes revealTotalModified4 {
        0% {
          transform: translateY(0);
          opacity: 0;
        }

        42% {
          transform: translateY(0);
          opacity: 0;
        }

        44% {
          transform: translateY(0);
          opacity: 1;
        }

        60% {
          transform: translateY(0);
          opacity: 1;
        }

        62% {
          transform: translateY(0);
          opacity: 0;
        }

        100% {
          transform: translateY(0);
          opacity: 0;
        }
      }

      @keyframes revealTotal5 {
        0% {
          transform: translateY(0);
          opacity: 0;
        }

        60% {
          transform: translateY(0);
          opacity: 0;
        }

        62% {
          transform: translateY(0);
          opacity: 1;
        }

        100% {
          transform: translateY(0);
          opacity: 1;
        }
      }

      @keyframes revealTotalModified1 {
        0% {
          transform: translateY(0);
          opacity: 1;
        }

        60% {
          transform: translateY(0);
          opacity: 1;
        }

        62% {
          transform: translateY(-10%) scale(1.25);
          opacity: 0;
        }

        100% {
          transform: translateY(-10%) scale(1.25);
          opacity: 0;
        }
      }

      @keyframes revealTotalModified2 {
        0% {
          transform: translateY(0);
          opacity: 0;
        }

        60% {
          transform: translateY(0);
          opacity: 0;
        }

        62% {
          opacity: 1;
          transform: translateY(0);
        }

        100% {
          transform: translateY(0);
          opacity: 1;
        }
      }


      @keyframes revealFateOne {
        0% {
          opacity: 1;
          transform: translateX(2220px);
        }

        48% {
          opacity: 1;
          transform: translateX(2220px);
        }

        49% {
          opacity: 1;
          transform: translateX(960px);
        }

        59% {
          opacity: 1;
          transform: translate(930px);
        }

        59.5% {
          opacity: 0;
          transform: translateX(920px);
        }

        100% {
          opacity: 0;
          transform: translateX(920px);
        }
      }

      @keyframes revealFateTwo {
        0% {
          opacity: 1;
          transform: translateX(-2220px);
        }

        48% {
          opacity: 1;
          transform: translateX(-2220px);
        }

        49% {
          opacity: 1;
          transform: translateX(-960px);
        }

        59% {
          opacity: 1;
          transform: translate(-930px);
        }

        59.5% {
          opacity: 0;
          transform: translateX(-920px);
        }

        100% {
          opacity: 0;
          transform: translateX(-920px);
        }
      }

      @keyframes strobe {
        0% {
          opacity: 1;
        }

        100% {
          opacity: 0;
        }
      }

      @keyframes slideDamageRight {
        0% {
          transform: translate(-100%, -50%);
        }

        68% {
          transform: translate(-100%, -50%);
        }

        70% {
          transform: translate(0, -50%);
        }

        85% {
          transform: translate(0, -50%);
        }

        87% {
          transform: translate(100%, -50%);
        }

        100% {
          transform: translate(100%, -50%);
        }
      }

      @keyframes slideDamageTargetRight {
        0% {
          opacity: 0;
          transform: translateX(-10%);
        }

        68% {
          opacity: 0;
          transform: translateX(-10%);
        }

        70% {
          opacity: 1;
          transform: translateX(3.5%);
        }

        75% {
          opacity: 1;
          transform: translateX(0%);
        }

        100% {
          opacity: 1;
          transform: translateX(0%);
        }
      }

      @keyframes slideDamageAmountRight {
        0% {
          opacity: 0;
          transform: translateX(-10%);
        }

        70% {
          opacity: 0;
          transform: translateX(-10%);
        }

        72% {
          opacity: 1;
          transform: translateX(3.5%);
        }

        77% {
          opacity: 1;
          transform: translateX(0%);
        }

        100% {
          opacity: 1;
          transform: translateX(0);
        }
      }

      @keyframes slideDamageLeft {
        0% {
          transform: translate(100%, -50%);
        }

        68% {
          transform: translate(100%, -50%);
        }

        70% {
          transform: translate(0, -50%);
        }

        85% {
          transform: translate(0, -50%);
        }

        87% {
          transform: translate(-100%, -50%);
        }

        100% {
          transform: translate(-100%, -50%);
        }
      }


      @keyframes slideDamageTargetLeft {
        0% {
          opacity: 0;
          transform: translateX(10%);
        }

        68% {
          opacity: 0;
          transform: translateX(10%);
        }

        70% {
          opacity: 1;
          transform: translateX(-3.5%);
        }

        75% {
          opacity: 1;
          transform: translateX(0%);
        }

        100% {
          opacity: 1;
          transform: translateX(0%);
        }
      }

      @keyframes slideDamageAmountLeft {
        0% {
          opacity: 0;
          transform: translateX(10%);
        }

        70% {
          opacity: 0;
          transform: translateX(10%);
        }

        72% {
          opacity: 1;
          transform: translateX(-3.5%);
        }

        77% {
          opacity: 1;
          transform: translateX(0%);
        }

        100% {
          opacity: 1;
          transform: translateX(0);
        }
      }



      :host {
        @apply --layout-fit;
        transition: transform 0.3s ease-in-out;

        --polymon-portrait-background: transparent;
        overflow: hidden;
      }

      :host(.one) {
        transform: translate(-100%, 0);
        background-color: #37FFFE;
      }

      :host(.two) {
        transform: translate(100%, 0);
        background-color: #607CFB;
      }

      :host(.playing) {
        transform: translate(0, 0);
      }

      :host(:not(.playing)) * {
        animation-name: none;
      }

      #scene * {
        animation-timing-function: linear;
        animation-delay: 1s;
        animation-duration: 10s;
        animation-iteration-count: 1;
        animation-fill-mode: forwards;
      }

      video {
        width: 100%;
        height: 100%;
      }

      polymon-portrait {
        position: absolute;
      }

      :host(.one) polymon-portrait {
        top: 0;
        left: 0;
        transform: translate(200px, 200px);
        animation-name: attackOne;
      }

      :host(.two) polymon-portrait {
        right: 0;
        bottom: 0;
        transform: translate(-200px, -400px);
        animation-name: attackTwo;
      }

      #screen {
        @apply --layout-fit;
        background-color: #fff;

        opacity: 0;
        animation-name: flash;
      }

      #stat {
        position: absolute;
        display: flex;
        align-items: center;
        color: rgba(255, 255, 255, 0.75);
        font-size: 256px;
        line-height: 132px;
        font-weight: bold;
        text-transform: uppercase;
        text-shadow: 0px 0px 20px #fff;
        opacity: 0;
      }

      :host(.one) #stat {
        flex-direction: column-reverse;
        right: 0;
        bottom: 0;
        transform: translate(-100px, -50px);
        animation-name: showStatOne;
      }

      :host(.two) #stat {
        flex-direction: column;
        left: 0;
        top: 0;
        transform: translate(100px, 50px);
        animation-name: showStatTwo;
      }

      #stat > .bonus {
        font-size: 100px;
      }

      #value {
        position: absolute;
        color: rgba(255, 255, 255, 0.75);
        font-size: 500px;
        font-weight: bold;
        text-transform: uppercase;
        text-shadow: 0px 0px 20px #fff;
      }

      :host(.one) #value {
        top: 250px;
        right: 600px;
        animation-name: revealValueOne;
      }

      :host(.two) #value {
        bottom: 800px;
        left: 300px;
        animation-name: revealValueTwo;
      }

      #value > span {
        position: absolute;
        opacity: 0;
      }

      #value > span:nth-of-type(1) {
        animation-name: revealTotal1;
      }

      #value > span:nth-of-type(2) {
        animation-name: revealTotal2;
      }

      #value > span:nth-of-type(3) {
        animation-name: revealTotal3;
      }

      #value > span:nth-of-type(4) {
        animation-name: revealTotal4;
      }

      #value.modified > span:nth-of-type(4) {
        animation-name: revealTotalModified4;
      }

      #value.bonus > span:nth-of-type(5) {
        animation-name: revealTotal5;
      }

      #value:not(.bonus).modified > span:nth-of-type(1) {
        animation-name: revealTotalModified1;
      }

      #value:not(.bonus).modified > span:nth-of-type(2) {
        animation-name: revealTotalModified2;
      }

      [hidden] {
        display: none;
      }

      #fate {
        position: absolute;
        color: rgba(255, 255, 255, 0.75);
        font-size: 200px;
        font-weight: bold;
        text-transform: uppercase;
        text-shadow: 0px 0px 20px #fff;
        transform: translateX(2220px);
      }

      :host(.one) #fate {
        top: 0;
        left: 0;
        animation-name: revealFateOne;
      }

      :host(.two) #fate {
        bottom: 0;
        right: 0;
        animation-name: revealFateTwo;
      }

      #damage {
        position: absolute;
        box-sizing: border-box;
        width: 100%;
        top: 50%;
        color: rgba(0, 0, 0, 0.7);
        text-transform: uppercase;
        display: flex;
        flex-direction: column;
        align-items: center;
        font-weight: bold;
        padding: 3em;
        text-shadow: 0 0 20px rgba(0, 0, 0, 0.75);

        transform: translate(-100%, -50%);
      }

      #damage, #damage * {
        animation-timing-function: ease;
      }

      :host(.one) #damage.visible {
        animation-name: slideDamageLeft;
      }

      :host(.two) #damage.visible {
        animation-name: slideDamageRight;
      }

      #damage:not(.visible) > * {
        animation-name: none;
      }

      #damage > :first-child {
        font-size: 96px;
        line-height: 128px;
        z-index: 1;
        opacity: 0;
      }

      :host(.one) #damage > :first-child {
        animation-name: slideDamageTargetLeft;
      }

      :host(.two) #damage > :first-child {
        animation-name: slideDamageTargetRight;
      }

      #damage > :last-child {
        font-size: 256px;
        line-height: 224px;
        z-index: 1;
      }

      :host(.one) #damage > :left-child {
        animation-name: slideDamageAmountLeft;
      }

      :host(.two) #damage > :left-child {
        animation-name: slideDamageAmountRight;
      }

      #damage:before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        bottom: 0;
        right: 0;
        background-color: #ff6c00;
      }

      #damage:after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        bottom: 0;
        right: 0;
        opacity: 0;
        background-color: rgba(255, 255, 255, 0.25);
        animation: strobe 0.75s infinite linear;
      }
    </style>
    <video
        id="video"
        src="[[__computeVideoSrc(player)]]"
        preload="auto"
        muted>
    </video>
    <div id="scene">
      <polymon-portrait
          polymon="[[config.polymon]]"
          size="640"
          caught>
      </polymon-portrait>
      <span id="stat">
        <span>[[config.move.attributeName]]</span>
        <span hidden="[[!config.move.gotBonus]]" class="bonus">BONUS +3</span>
      </span>
      <span id="value" class$="[[__computeValueClass(config)]]">
        <template is="dom-repeat" items="[[config.scoreSequence]]" as="score">
          <span>[[score]]</span>
        </template>
      </span>
      <span id="fate">
        <span>FATE</span> <span>[[config.fateSymbol]][[config.move.randomModifier]]</span>
      </span>
      <span id="damage" class$="[[__computeDamageClass(config)]]">
        <span>PLAYER [[player]] TAKES</span>
        <span>[[config.move.damageDelta]] DAMAGE</span>
      </span>
      <div id="screen"></div>
    </div>
  </template>
  <script>
    Polymer({
      is: 'polymon-tournament-move-visualizer',

      behaviors: [PolymonElement],

      properties: {
        player: {
          type: String,
          observer: '__playerChanged'
        },

        teamStatus: {
          type: Array
        },

        config: {
          type: Object
        }
      },

      play(move) {
        if (this.teamStatus == null || this.teamStatus.length === 0) {
          return Promise.resolve();
        }

        return new Promise(resolve => {
          requestAnimationFrame(() => {
            console.log(move);
            console.log(this.teamStatus);

            const polymon = this.__getMovePolymon(move);
            const statValue = polymon.stats[move.attributeName];
            const scoreSequence = this.__getScoreSequence(move, statValue);
            const fateSymbol = move.randomModifier > 0
                ? '+'
                : '';

            // move.damageDelta...
            Polymer.dom(this.root).removeChild(this.$.scene);
            Polymer.dom(this.root).appendChild(this.$.scene);

            this.config = {
              move,
              polymon,
              statValue,
              fateSymbol,
              scoreSequence
            };

            this.classList.add('playing');

            resolve(this.awaitTransition(this, 4000).then(() => {
              this.$.video.play();
              return this.awaitEvent(this.$.video, 'pause', 12000).then(() => {
                this.$.video.currentTime = 0;
                this.classList.remove('playing');
                console.log('DONE!');
              });
            }));
          });
        });
      },

      __getScoreSequence(move, attributeValue) {
        const scoreSequence = [attributeValue];

        if (move.gotBonus) {
          for (let i = 0; i < 3; ++i) {
            scoreSequence.push(attributeValue + i + 1);
          }
        }

        if (move.randomModifier != null) {
          let modifier;

          if (move.gotBonus) {
            modifier = scoreSequence[scoreSequence.length - 1] +
                move.randomModifier;
          } else {
            modifier = attributeValue + move.randomModifier;
          }

          scoreSequence.push(modifier);
        }

        return scoreSequence;
      },

      __getMovePolymon(move) {
        const teamStatus = this.teamStatus;
        let polymon = null;

        for (let i = 0; i < teamStatus.length; ++i) {
          const teamPosition = teamStatus[i];

          if (teamPosition.polydexId === move.polydexId) {
            polymon = teamPosition.polymon;
          }
        }

        return polymon;
      },

      __computeVideoSrc(player) {
        if (player != null) {
          return this.resolveUrl(`../../video/battle_player_${player}.webm`);
        }
      },

      __playerChanged(player, oldPlayer) {
        if (oldPlayer != null) {
          this.classList.remove(oldPlayer);
        }

        if (player != null) {
          this.classList.add(player);
        }
      },

      __computeValueClass(config) {
        const classes = [];

        if (config.move.gotBonus) {
          classes.push('bonus');
        }

        classes.push('modified');

        return classes.join(' ');
      },

      __computeDamageClass(config) {
        const damage = config.move.damageDelta;

        return damage > 0
            ? 'visible'
            : '';
      }
    });
  </script>
</dom-module>

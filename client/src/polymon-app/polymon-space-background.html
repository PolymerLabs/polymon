<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">

<link rel="import" href="polymon-element.html">

<dom-module id="polymon-space-background">
  <template>
    <style>
      :host {
        @apply --layout-fit;

        background-color: #4b4970;
        background-image:
          linear-gradient(to bottom, #04072f, #4f496f 30%, #bd97a8 70%, #a193a8);
      }

      .image {
        @apply --layout-fit;

        background-size: cover;
        background-position: var(--polymon-space-background-position, 50% 50%);

        opacity: 0;
        transition: opacity 1s;
      }

      .image.visible {
        opacity: 1;
      }

      .image.skip-transition {
        transition: none;
      }
    </style>
    <div class="image" id="bg1x"></div>
    <div class="image" id="bg2x"></div>
  </template>
  <script>
    Polymer({
      is: 'polymon-space-background',

      behaviors: [PolymonElement],

      properties: {
        __is2x: {
          type: Object,
          value: window.matchMedia("(min-resolution: 2dppx), (min-width: 700px), (min-height: 700px)"),
        },

        preventLoad: {
          type: Boolean,
          value: false,
          reflectToAttribute: true,
          observer: '__preventLoadChanged',
        },
      },

      ready: function() {
        this.__bg1xLoadStarted = false;
        this.__bg2xLoadStarted = false;

        this.__is2x.addListener(this.__load.bind(this));

        // Skip the transition if the image loads before the next paint (i.e. if
        // it's cached).
        this.__skipTransition = true;
        requestAnimationFrame(() => {
          this.__skipTransition = false;
        });
      },

      __preventLoadChanged: function() {
        if (!this.preventLoad) {
          this.__load();
        }
      },

      __load: function() {
        const is2x = this.__is2x.matches;

        if (is2x) {
          if (this.__bg2xLoadStarted) {
            return;
          }

          this.__bg2xLoadStarted = true;
          // Don't switch back to 1x once 2x has started loading.
          this.__bg1xLoadStarted = true;
        } else {
          if (this.__bg1xLoadStarted) {
            return;
          }

          this.__bg1xLoadStarted = true;
        }

        const bgElement = is2x
            ? this.$.bg2x
            : this.$.bg1x;
        const bgSrc = is2x
            ? "/images/space_bg@2x.jpg"
            : "/images/space_bg@1x.jpg";

        // Load the background image without displaying it. Once it has loaded
        // set the background of the associated div and fade it in.
        const background = new Image();
        // This should match the media query in the CSS above.
        background.src = bgSrc;
        background.onload = () => {
          bgElement.style.backgroundImage = `url(${background.src})`;
          bgElement.classList.toggle('visible', true);
          bgElement.classList.toggle('skip-transition', this.__skipTransition);
        };
      },
    });
  </script>
</dom-module>

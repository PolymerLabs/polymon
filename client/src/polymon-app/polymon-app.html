<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/app-route/app-location.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-auth.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-document.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-query.html">
<link rel="import" href="polymon-element.html">
<link rel="import" href="polymon-lazy-loader.html">

<dom-module id="polymon-app">
  <template>
    <style>
      :host {
        --polymon-blue: #3EBBF0;
        --polymon-blue-2: #2BA8DE;
        --polymon-blue-3: #238AB6;
        --polymon-red: #F73463;
        --polymon-red-2: #E22D54;
        --polymon-font-family: 'Bungee', sans-serif;
        --polymon-headline-font-family: 'Bungee Inline', sans-serif;
        --polymon-body-font-family: sans-serif;
        @apply --layout-fit;
        @apply --layout-vertical;
        background-color: #eee;
        overflow: hidden;

        -webkit-font-smoothing: antialiased;
      }

      [unresolved] {
        opacity: 0;
      }
    </style>

    <firebase-auth
        app-name="polymon"
        provider="google"
        signed-in="{{authenticated}}"
        status-known="{{statusKnown}}"
        user="{{user}}"
        id="auth">
    </firebase-auth>

    <firebase-query
        app-name="polymon"
        path="/polymons"
        data="{{polymons}}">
    </firebase-query>

    <firebase-query
        app-name="polymon"
        path="[[__computePolydexPath(user)]]"
        data="{{polydex}}">
    </firebase-query>

    <firebase-document
        id="userData"
        app-name="polymon"
        path="[[__computeUserDataPath(user)]]"
        data="{{userData}}">
    </firebase-document>

    <app-location
        route="{{route}}"
        query-params="{{queryParams}}">
    </app-location>

    <polymon-lazy-loader
        route="{{route}}">

      <app-route
          pattern="/"
          route="{{route}}"
          active="{{rootRouteActive}}"
          data-fragments='[
            "polymon-start-screen.html",
            "polymon-map.html"
          ]'>
      </app-route>

      <app-route
          pattern="/map"
          route="{{route}}"
          tail="{{mapRoute}}"
          active="{{mapRouteActive}}"
          data-fragments='[
            "polymon-map.html",
            "polymon-qr-code-scanner.html"
          ]'>
      </app-route>

      <app-route
          pattern="/caught/:polymonId"
          route="{{route}}"
          active="{{caughtRouteActive}}"
          data="{{caughtData}}"
          query-params="{{caughtQueryParams}}"
          data-fragments='[
            "polymon-caught-screen.html"
          ]'>
      </app-route>

      <app-route
          pattern="/polydex"
          route="{{route}}"
          tail="{{polydexRoute}}"
          active="{{polydexRouteActive}}"
          data-fragments='[
            "polymon-map.html",
            "polymon-panel.html",
            "polymon-polydex.html"
          ]'>
      </app-route>

      <app-route
          pattern="/battle/new"
          route="{{route}}"
          tail="{{newBattleRoute}}"
          active="{{newBattleRouteActive}}"
          data-fragments='[
            "polymon-map.html",
            "polymon-panel.html",
            "polymon-qr-code-scanner.html",
            "polymon-new-battle-screen.html"
          ]'>
      </app-route>

      <app-route
          pattern="/battle/tutorial"
          route="{{route}}"
          active="{{battleTutorialRouteActive}}"
          data-fragents='[]'>
      </app-route>

      <app-route
          pattern="/battle/engage/:id"
          route="{{route}}"
          data="{{engageBattleData}}"
          active="{{engageBattleRouteActive}}"
          data-fragments='[
            "polymon-battle-screen.html"
          ]'>
      </app-route>

    </polymon-lazy-loader>

    <polymon-qr-code-scanner
        unresolved
        id="scanner">
    </polymon-qr-code-scanner>

    <polymon-map
        unresolved
        id="map"
        active="[[mapRouteActive]]"
        route="{{mapRoute}}"
        user="[[user]]"
        polymons="[[polymons]]">
    </polymon-map>

    <polymon-start-screen
        unresolved
        active="[[rootRouteActive]]"
        hidden="[[mapRouteActive]]"
        authenticated="[[authenticated]]"
        on-request-login="attemptLogin">
    </polymon-start-screen>

    <!-- TODO(cdata): Consider moving this to the map screen? -->
    <polymon-caught-screen
        unresolved
        active="[[caughtRouteActive]]"
        data="[[caughtData]]"
        continue-to="[[caughtQueryParams.continueTo]]">
    </polymon-caught-screen>

    <polymon-panel
        unresolved
        active-index="[[__computePanelIndex(polydexRouteActive, newBattleRouteActive, battleTutorialRouteActive, rootRouteActive)]]"
        active="[[or(polydexRouteActive, newBattleRouteActive, battleTutorialRouteActive)]]">
      <polymon-polydex
          active="[[polydexRouteActive]]"
          available-polymons="[[polymons]]"
          caught-polymons="[[polydex]]"
          route="{{polydexRoute}}"
          user="[[user]]">
      </polymon-polydex>
      <polymon-new-battle-screen
          active="[[newBattleRouteActive]]"
          route="{{newBattleRoute}}"
          user="[[user]]"
          user-data="{{userData}}">
      </polymon-new-battle-screen>
      <polymon-battle-tutorial>
      </polymon-battle-tutorial>
    </polymon-panel>

    <polymon-battle-screen
        unresolved
        active="[[engageBattleRouteActive]]"
        user="[[user]]"
        battle-id="[[engageBattleData.id]]"
        user-data="{{userData}}">
    </polymon-battle-screen>

  </template>

  <script>
    Polymer({
      is: 'polymon-app',

      behaviors: [
        PolymonElement
      ],

      properties: {
        polymons: {
          type: Array
        },

        polydex: {
          type: Array
        },

        unconfirmedCatches: {
          type: Array,
          value: function() {
            return [];
          }
        }
      },

      listeners: {
        'polymon-code': '__onPolymonCode',
        'polydex-entry-added': '__onPolydexEntryAdded'
      },

      observers: [
        '__activeBattleIdChanged(userData.player.activeBattleId, route.path)',
        '__polydexChanged(polydex.*)',
        '__statusKnownChanged(statusKnown)'
      ],

      attemptLogin: function() {
        this.$.auth.signInWithPopup();
      },

      __statusKnownChanged: function() {
        if (this.statusKnown && !this.$.auth.signedIn) {
          this.set('route.path', '/');
        }
      },

      __activeBattleIdChanged: function(activeBattleId) {
        if (activeBattleId != null) {
          this.set('route.path', `/battle/engage/${activeBattleId}`);
        }
      },

      __onPolymonCode: function(event) {
        let { type, code, continueTo } = event.detail;

        if (this.$.userData.ref) {
          switch (type) {
            case 'reference':
              this.set('queryParams.continueTo', continueTo);
              this.push('unconfirmedCatches',
                this.$.userData.ref.child('catchQueue').push({
                  code: code,
                  latLng: this.$.map.playerLatLng
                }).key);
              break;
            case 'battle':
              this.$.userData.ref.child('battleQueue').push({
                action: 'join',
                battleId: code,
                createdAt: Date.now()
              });
              break;
          }
        }
      },

      __onPolydexEntryAdded: function(event) {
        let polydexEntry = event.detail;

        for (let i = 0; i < this.unconfirmedCatches.length; ++i) {
          let catchId = this.unconfirmedCatches[i];

          if (catchId === polydexEntry.catchId) {
            this.unconfirmedCatches.splice(i, 1);
            this.set('route.path', `/caught/${polydexEntry.polymonId}`);
          }
        }
      },

      __computePolydexPath: function(user) {
        return user
            ? `/users/${user.uid}/polydex`
            : null;
      },

      __computeUserDataPath: function(user) {
        return user
            ? `/users/${user.uid}`
            : null;
      },

      __computePanelIndex: function(polydexRouteActive, newBattleRouteActive, battleTutorialRouteActive, rootRouteActive) {
        if (rootRouteActive) {
          return 0;
        } else if (battleTutorialRouteActive) {
          return 2;
        } else if (newBattleRouteActive) {
          return 1;
        } else if (polydexRouteActive) {
          return 0;
        }
      },

      __polydexChanged: function(change) {
        let splices = change.value.indexSplices;

        if (!splices) {
          return;
        }

        let queue = Promise.resolve();

        splices.forEach(splice => {
          for (let i = 0; i < splice.addedCount; ++i) {
            let polydexEntry = splice.object[splice.index + i];
            this.fire('polydex-entry-added', polydexEntry);
          }
        });
      }
    });
  </script>
</dom-module>

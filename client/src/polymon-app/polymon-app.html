<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/app-route/app-location.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-auth.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-document.html">
<link rel="import" href="polymon-map.html">
<link rel="import" href="polymon-start-screen.html">
<link rel="import" href="polymon-caught-screen.html">
<link rel="import" href="polymon-polydex.html">
<link rel="import" href="polymon-element.html">
<link rel="import" href="polymon-new-battle-screen.html">
<link rel="import" href="polymon-battle-screen.html">
<link rel="import" href="polymon-panel.html">
<link rel="import" href="polymon-qr-code-scanner.html">

<dom-module id="polymon-app">
  <template>
    <style>
      :host {
        --polymon-blue: #3EBBF0;
        --polymon-font-family: 'Bungee', sans-serif;
        --polymon-headline-font-family: 'Bungee Inline', sans-serif;
        --polymon-body-font-family: sans-serif;
        @apply --layout-fit;
        @apply --layout-vertical;
        background-color: #eee;
        overflow: hidden;

        -webkit-font-smoothing: antialiased;
      }
    </style>

    <firebase-auth
        app-name="polymon"
        provider="google"
        signed-in="{{authenticated}}"
        user="{{user}}"
        id="auth">
    </firebase-auth>

    <firebase-document
        id="userData"
        app-name="polymon"
        path="[[__computeUserDataPath(user)]]"
        data="{{userData}}">
    </firebase-document>

    <app-location
        route="{{route}}"
        query-params="{{queryParams}}">
    </app-location>
    <app-route
        pattern="/"
        route="{{route}}"
        active="{{rootRouteActive}}">
    </app-route>
    <app-route
        pattern="/map"
        route="{{route}}"
        tail="{{mapRoute}}"
        active="{{mapRouteActive}}">
    </app-route>
    <app-route
        pattern="/caught/:shortName"
        route="{{route}}"
        active="{{caughtRouteActive}}"
        data="{{caughtData}}"
        query-params="{{caughtQueryParams}}">
    </app-route>

    <app-route
        pattern="/polydex"
        route="{{route}}"
        tail="{{polydexRoute}}"
        active="{{polydexRouteActive}}">
    </app-route>

    <app-route
        pattern="/battle/new"
        route="{{route}}"
        tail="{{newBattleRoute}}"
        active="{{newBattleRouteActive}}">
    </app-route>
    <app-route
        pattern="/battle/tutorial"
        route="{{route}}"
        active="{{battleTutorialRouteActive}}">
    </app-route>
    <app-route
        pattern="/battle/engage/:id"
        route="{{route}}"
        active="{{engageBattleRouteActive}}">
    </app-route>

    <polymon-map
        active="[[mapRouteActive]]"
        route="{{mapRoute}}"
        user="[[user]]">
    </polymon-map>

    <polymon-start-screen
        active="[[rootRouteActive]]"
        hidden="[[mapRouteActive]]"
        authenticated="[[authenticated]]"
        on-request-login="attemptLogin">
    </polymon-start-screen>

    <polymon-caught-screen
        active="[[caughtRouteActive]]"
        data="[[caughtData]]"
        continue-to="[[caughtQueryParams.continueTo]]">
    </polymon-caught-screen>

    <polymon-panel
        active-index="[[__computePanelIndex(polydexRouteActive, newBattleRouteActive, battleTutorialRouteActive)]]"
        active="[[or(polydexRouteActive, newBattleRouteActive, battleTutorialRouteActive)]]">
      <polymon-polydex
          active="[[polydexRouteActive]]"
          route="{{polydexRoute}}"
          user="[[user]]">
      </polymon-polydex>
      <polymon-new-battle-screen
          active="[[newBattleRouteActive]]"
          route="{{newBattleRoute}}"
          user="[[user]]"
          user-data="{{userData}}">
      </polymon-new-battle-screen>
      <polymon-battle-tutorial>
      </polymon-battle-tutorial>
    </polymon-panel>

    <polymon-qr-code-scanner
        id="scanner">
    </polymon-qr-code-scanner>

    <polymon-battle-screen
        route="{{route}}"
        active="[[engageBattleRouteActive]]"
        user="[[user]]"
        user-data="{{userData}}">
    </polymon-battle-screen>

  </template>

  <script>
    Polymer({
      is: 'polymon-app',

      behaviors: [
        PolymonElement
      ],

      properties: {
        unconfirmedCatches: {
          type: Array,
          value: function() {
            return [];
          }
        }
      },

      listeners: {
        'polymon-code': '__onPolymonCode',
        'polydex-entry-added': '__onPolydexEntryAdded'
      },

      observers: [
        '__activeBattleIdChanged(userData.player.activeBattleId, route.path)'
      ],

      attemptLogin: function() {
        this.$.auth.signInWithPopup();
      },

      __activeBattleIdChanged: function(activeBattleId) {
        if (activeBattleId != null) {
          this.set('route.path', `/battle/engage/${activeBattleId}`);
        }
      },

      __onPolymonCode: function(event) {
        let { type, code, continueTo } = event.detail;

        if (this.$.userData.ref) {
          switch (type) {
            case 'reference':
              this.set('queryParams.continueTo', continueTo);
              this.push('unconfirmedCatches',
                this.$.userData.ref.child('catchQueue').push(code).key);
              break;
            case 'battle':
              this.$.userData.ref.child('battleQueue').push({
                action: 'join',
                battleId: code,
                createdAt: Date.now()
              });
              break;
          }

        }
      },

      __onPolydexEntryAdded: function(event) {
        let { polydexEntry, polymon } = event.detail;

        for (let i = 0; i < this.unconfirmedCatches.length; ++i) {
          let catchId = this.unconfirmedCatches[i];

          if (catchId === polydexEntry.catchId) {
            this.unconfirmedCatches.splice(i, 1);
            this.set('route.path', `/caught/${polymon.shortName}`);
          }
        }
      },

      __computeUserDataPath: function(user) {
        return user
            ? `/users/${user.uid}`
            : null;
      },

      __computePanelIndex: function(polydexRouteActive, newBattleRouteActive, battleTutorialRouteActive) {
        if (battleTutorialRouteActive) {
          return 2;
        } else if (newBattleRouteActive) {
          return 1;
        } else if (polydexRouteActive) {
          return 0;
        }
      }
    });
  </script>
</dom-module>

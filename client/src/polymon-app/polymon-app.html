<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/app-route/app-location.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-auth.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-document.html">
<link rel="import" href="polymon-map.html">
<link rel="import" href="polymon-start-screen.html">
<link rel="import" href="polymon-caught-screen.html">
<link rel="import" href="polymon-polydex.html">
<link rel="import" href="polymon-element.html">
<link rel="import" href="polymon-battle-screen.html">

<dom-module id="polymon-app">
  <template>
    <style>
      :host {
        --polymon-font-family: 'kenvector', sans-serif;
        @apply --layout-fit;
        @apply --layout-vertical;
        background-color: #eee;
        overflow: hidden;
      }
    </style>

    <firebase-auth
        app-name="polymon"
        provider="google"
        signed-in="{{authenticated}}"
        user="{{user}}"
        id="auth">
    </firebase-auth>

    <firebase-document
        id="userData"
        app-name="polymon"
        path="[[__computeUserDataPath(user)]]"
        data="{{userData}}">
    </firebase-document>

    <app-location
        route="{{route}}"
        query-params="{{queryParams}}">
    </app-location>
    <app-route
        pattern="/"
        route="{{route}}"
        active="{{rootRouteActive}}">
    </app-route>
    <app-route
        pattern="/map"
        route="{{route}}"
        tail="{{mapRoute}}"
        active="{{mapRouteActive}}">
    </app-route>
    <app-route
        pattern="/caught/:shortName"
        route="{{route}}"
        active="{{caughtRouteActive}}"
        data="{{caughtData}}"
        query-params="{{caughtQueryParams}}">
    </app-route>
    <app-route
        pattern="/battle"
        route="{{route}}"
        tail="{{battleRoute}}"
        active="{{battleRouteActive}}">
    </app-route>

    <app-route
        pattern="/polydex"
        route="{{route}}"
        tail="{{polydexRoute}}"
        active="{{polydexRouteActive}}">
    </app-route>

    <polymon-map
        active="[[mapRouteActive]]"
        route="{{mapRoute}}"
        user="[[user]]">
    </polymon-map>

    <polymon-start-screen
        active="[[rootRouteActive]]"
        hidden="[[mapRouteActive]]"
        authenticated="[[authenticated]]"
        on-request-login="attemptLogin">
    </polymon-start-screen>

    <polymon-caught-screen
        active="[[caughtRouteActive]]"
        data="[[caughtData]]"
        continue-to="[[caughtQueryParams.continueTo]]">
    </polymon-caught-screen>

    <polymon-polydex
        active="[[polydexRouteActive]]"
        route="{{polydexRoute}}"
        user="[[user]]">
    </polymon-polydex>

    <polymon-battle-screen
        active="[[battleRouteActive]]"
        route="{{battleRoute}}"
        user="[[user]]"
        user-data="{{userData}}">
    </polymon-battle-screen>
  </template>

  <script>
    Polymer({
      is: 'polymon-app',

      behaviors: [
        PolymonElement
      ],

      properties: {
        unconfirmedCatches: {
          type: Array,
          value: function() {
            return [];
          }
        }
      },

      listeners: {
        'polymon-code': '__onPolymonCode',
        'polydex-entry-added': '__onPolydexEntryAdded'
      },

      observers: [
        // TODO(cdata): Use this to force-resume battles in progress when the
        // app reloads:
        // '__activeBattleIdChanged(userData.player.activeBattleId)'
      ],

      attemptLogin: function() {
        this.$.auth.signInWithPopup();
      },

      __onPolymonCode: function(event) {
        let code = event.detail.code;
        let continueTo = event.detail.continueTo;

        if (this.$.userData.ref) {
          this.set('queryParams.continueTo', continueTo);
          this.push('unconfirmedCatches',
              this.$.userData.ref.child('catchQueue').push(code).key);
        }
      },

      __onPolydexEntryAdded: function(event) {
        let { polydexEntry, polymon } = event.detail;

        for (let i = 0; i < this.unconfirmedCatches.length; ++i) {
          let catchId = this.unconfirmedCatches[i];

          if (catchId === polydexEntry.catchId) {
            this.unconfirmedCatches.splice(i, 1);
            this.set('route.path', `/caught/${polymon.shortName}`);
          }
        }
      },

      __computeUserDataPath: function(user) {
        return user
            ? `/users/${user.uid}`
            : null;
      }
    });
  </script>
</dom-module>

<script>
  (() => {
    /** @polymerBehavior */
    PolymonRenderableBehavior = {
      properties: {
        hidden: {
          type: Boolean,
          reflectToAttribute: true,
          observer: '_hiddenChanged',
        },

        hideDelay: {
          type: Number,
          value: 300
        },

        _isHiddenDirty: {
          type: Boolean,
          value: false
        },

        __hidingTimeout: {
          type: Number
        }
      },

      attached: function() {
        this.fire('polymon-renderable-attached', { item: this });
      },

      /**
       * @abstract
       *
       * Applies or removes the `hidden` attribute on the element (defaults to
       * hidden). Override for element-specific rendering.
       *
       * @param {boolean=} shouldBeVisible whether or not the element should
       *    be visible. Defaults to false.
       * @param {Object=} config configs for specific render function
       * @returns {Promise<boolean>} whether or not the element should be visible. True
       *    if set `hidden` attribute. False if removed it.
       */
      render: function(shouldBeVisible, config) {
        if (this.__hidingTimeout) {
          console.log('cancelling');
          this.cancelAsync(this.__hidingTimeout);
          this.__hidingTimeout = null;
        }

        this._isHiddenDirty = true;

        if (config && config.observed) {
          shouldBeVisible = !this.hidden;
        }

        if (shouldBeVisible) {
          this.hidden = false;
          this._isHiddenDirty = false;

        } else {

          this.__hidingTimeout = this.async(() => {
            this.hidden = true;
            this._isHiddenDirty = false;
          }, this.hideDelay);
        }

        return shouldBeVisible;
      },

      _hiddenChanged: function() {
        if (this._isHiddenDirty) {
          return;
        }

        this.render(null, { observed: true });
      }
    };
  })();
</script>

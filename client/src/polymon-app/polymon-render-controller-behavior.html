<link rel="import" href="../../bower_components/iron-selector/iron-multi-selectable.html">

<script>
  (() => {
    /** @polymerBehavior */
    const PolymonRenderControllerBehaviorImpl = {
      properties: {
        siteMap: {
          type: Object
        },

        attrForSelected: {
          type: String,
          value: 'page-name'
        },

        renderPath: {
          type: String,
          observer: '_renderPathChanged'
        },

        multi: {
          type: Boolean,
          value: true
        },

        activateEvent: {
          type: String,
          value: 'ignore'
        },

        selectable: {
          type: String,
          value: '[page-name]'
        },

        selectedClass: {
          type: String,
          value: 'rendered'
        }
      },

      listeners: {
        'iron-select': '_renderElement',
        'iron-deselect': '_renderElement',
        'polymon-renderable-attached': '_renderElement'
      },

      renderChildren: function(path) {
        if (!this.siteMap) {
          return null;
        }

        const pathParts = path.split('/');
        let subMap = this.siteMap;

        for(const pathPart of pathParts) {
          let dirtySubmap = subMap._default || subMap[pathPart];

          // ends in /, use previous level
          if (pathPart === '' && !dirtySubmap) {
            break;
          }

          subMap = dirtySubmap;

          if (subMap === undefined) {
            return null;
          }
        }

        const newIds = subMap._elements;
        this.selectedValues = Array.from(newIds);
        return this.selectedValues;
      },

      _renderElement: function(e) {
        const element = e.detail.item;
        if (element == this || !element.getAttribute('page-name')) {
          return;
        }

        const renderFn = element.render;
        const pageName = element.getAttribute('page-name');
        const shouldRender = this.selectedValues.indexOf(pageName) >= 0;
        e.stopPropagation();

        if (renderFn) {
          element.render(shouldRender, { path: this.renderPath });

        } else if(Polymer.isInstance(element)) {
        }
      },

      _renderPathChanged: function() {
        this.renderChildren(this.renderPath);
      }
    };

    /** @polymerBehavior */
    PolymonRenderControllerBehavior = [
      Polymer.IronMultiSelectableBehavior,
      PolymonRenderControllerBehaviorImpl
    ];
  })();
</script>
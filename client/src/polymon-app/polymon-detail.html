<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-document.html">
<link rel="import" href="polymon-element.html">
<dom-module id="polymon-detail">
  <template>
    <style>
      :host {
        position: absolute;
        top: 2px;
        left: 2px;
        right: 2px;
        bottom: 2px;
        overflow: hidden;
        border-radius: 6px;

        pointer-events: none;
        z-index: 2;

        transition: opacity 0s 0.5s;

        opacity: 0;
        --polymon-portrait-background: transparent;

        box-sizing: border-box;

        @apply --layout-vertical;

        align-items: center;
      }

      :host(.active) {
        pointer-events: all;
        opacity: 1;
        transition: opacity 0s 0s;
      }

      :host(.active.open) #background {
        transform: scale(22);
        background-color: #eee;
      }

      :host(.active:not(.open)) #portrait {
        transition: none;
        transition-delay: 0s;
      }

      :host(.active.open) #portrait {
        transform: translate(0, 0) scale(1) !important;
        transition-delay: 0.2s;
      }

      :host(.active.open) #info,
      :host(.active.open) #controls {
        transition-delay: 0.3s;
        transform: translateY(0);
        opacity: 1;
      }

      firebase-document {
        display: none;
      }

      #background {
        position: absolute;
        background-color: #ccc;
        backface-visibility: hidden;
        width: 64px;
        height: 64px;
        border-radius: 32px;
        will-change: transform;
        transition: transform 0.5s, background-color 0.3s;
        transform-origin: center center;
      }

      #info, #marquee {
        flex: 1;
      }

      #marquee {
        display: flex;
        @apply --layout-center-center;
      }

      #portrait {
        will-change: transform;
        transition: transform 0.3s;
        transition-delay: 0s;
        transform-origin: 0 0;
      }

      #info {
        @apply --layout-horizontal;
        flex-wrap: wrap;
        width: 100%;
        z-index: 2;
        overflow: auto;
      }

      #info, #controls {
        transition: transform 0.15s, opacity 0.15s;
        transition-delay: 0s;
        transform: translateY(10px);
        opacity: 0;
      }

      #info > #stats,
      #info > #flavor {
        flex: 1 1 240px;
      }

      #stats {
        margin-bottom: 20px;
      }

      #stats > h1 {
        font-family: 'Bungee Inline';
        font-size: 2.5em;
        margin: 0 0 0.5em;
        color: #444;
        font-weight: normal;
      }

      #stats > h2 {
        margin: 0 0 0.25em 0;
        font-weight: normal;
      }

      #flavor {
        font-family: sans-serif;
        font-style: italic;
        margin: 0 24px 1em;
        color: #444;
      }

      #controls {
        display: flex;
        align-items: flex-end;
        width: 100%;
        box-sizing: border-box;
        padding: 6px;
      }

      #controls a {
        width: 100%;
        -webkit-tap-highlight-color:  rgba(255, 255, 255, 0);
      }

      #controls polymon-button {
        width: 100%;
      }

      .attack {
        color: #F43865;
        text-shadow: 0 1px 0 #a31733;
      }

      .focus {
        color: #2BA8DE;
        text-shadow: 0 1px 0 #09537E;
      }

      .counter {
        color: #8BDE67;
        text-shadow: 0 1px 0 #498231;
      }

      @media (max-height: 600px) {
        :host(.active.open) #portrait {
          transform: translate(10%, 10%) scale(0.8) !important;
          transition-delay: 0.2s;
        }
      }

      @media (min-width: 500px) {
        :host(.active.open) #background {
          transform: scale(30);
        }
      }

      @media (min-width: 750px) {
        :host(.active.open) #background {
          transform: scale(35);
        }
      }

      @media (min-width: 1000px) {
        :host(.active.open) #background {
          transform: scale(50);
        }
      }

      @media (min-width: 1500px) {
        :host(.active.open) #background {
          transform: scale(70);
        }
      }
    </style>

    <firebase-document
        app-name="polymon"
        path="[[__polymonPath(polymonId)]]"
        data="{{polymon}}">
    </firebase-document>

    <div id="background"></div>

    <section id="marquee">
      <polymon-portrait
          id="portrait"
          polymon="[[polymon]]"
          caught="[[caught]]"
          size="256">
      </polymon-portrait>
    </section>

    <section id="info">
      <section id="stats">
        <h1>[[__infoText(polymon.name, caught)]]</h1>
        <h2 class="attack">Attack: <span>[[__infoText(polymon.stats.attack, caught)]]</span></h2>
        <h2 class="focus">Focus: <span>[[__infoText(polymon.stats.focus, caught)]]</span></h2>
        <h2 class="counter">Counter: <span>[[__infoText(polymon.stats.counter, caught)]]</span></h2>
      </section>
      <section id="flavor">
        <span>[[__infoText(polymon.flavor, caught)]]</span>
      </section>
    </section>

    <section id="controls">
      <a href="/polydex">
        <polymon-button class="alt">Back</polymon-button>
      </a>
      <!-- TODO(cdata): Trading button goes here? -->
    </section>

  </template>
  <script>
    Polymer({
      is: 'polymon-detail',

      behaviors: [
        PolymonElement
      ],

      properties: {
        originElement: {
          type: HTMLElement
        },

        polymonId: {
          type: String
        },

        caught: {
          type: Boolean,
          value: false
        },

        open: {
          type: Boolean,
          readOnly: true,
          value: false,
          observer: '__openChanged'
        }
      },

      observers: [
        '__openOrClose(polymonId, active)'
      ],

      get originElement() {
        let root = Polymer.dom(this).getOwnerRoot() || document;
        return Polymer.dom(root).querySelector(`#${this.polymonId}`);
      },

      __openChanged: function() {
        if (this.open) {
          this.classList.add('open');
        } else {
          this.classList.remove('open');
        }
      },

      __openOrClose: function() {
        this.deraf('openOrClose', () => {
          if (this.active) {
            this.$.portrait.style.transform = '';

            let selfBoundingRect = this.getBoundingClientRect();
            let portraitBoundingRect = this.$.portrait.getBoundingClientRect();
            let originElement = this.originElement;
            let scale = 64 / portraitBoundingRect.width;
            let top;
            let left;

            if (originElement) {
              let originBoundingRect =
                  this.originElement.getBoundingClientRect();

              top = originBoundingRect.top;
              left = originBoundingRect.left;
            } else {
              // TODO(cdata): Where does magic number 20 come from?
              top = (selfBoundingRect.height / 2) - 20;
              left = (selfBoundingRect.width / 2) - 20;
            }

            this.$.background.style.top = (top - selfBoundingRect.top) + 'px';
            this.$.background.style.left = (left - selfBoundingRect.left) + 'px';

            left = left - portraitBoundingRect.left;
            top = top - portraitBoundingRect.top;

            this.$.portrait.style.transform =
                `translate(${left}px,${top}px) scale(${scale})`;

            // this.classList.add('visible');

            // NOTE(cdata): This raf is kind of annoying. Without it, the
            // portrait will attempt to transition from its old initial position
            // to its new initial position:
            this.deraf('open', () => {
              this._setOpen(true);
            });
          } else {
            let self = this;

            // this.addEventListener('transitionend', function onTransitionEnd(event) {
            //   if (event.target === self.$.background && event.propertyName === 'transform') {
            //     this.removeEventListener('transitionend', onTransitionEnd);
            //
            //   }
            // });
            this._setOpen(false);
            // this.debounce('close', () => {
            //   this.classList.remove('visible');
            // }, 500);
          }
        });
      },

      __polymonPath: function(polymonId) {
        return `/polymons/${polymonId}`;
      },

      __infoText: function(text, caught) {
        text = text + '';

        if (!text || caught) {
          return text;
        }

        if (text.length < 5) {
          return '???';
        }

        return text.replace(/[^\s]/g, '?');
      }
    });
  </script>
</dom-module>

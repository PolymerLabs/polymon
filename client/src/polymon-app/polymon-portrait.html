<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="polymon-imageset.html">
<dom-module id="polymon-portrait">
  <template>
    <style>
      :host {
        display: flex;
        width: var(--polymon-portrait-size, 64px);
        height: var(--polymon-portrait-size, 64px);
        border-radius: calc(var(--polymon-portrait-size, 64px) / 2);
        margin: 4px;

        background-color: var(--polymon-portrait-background, #ccc);
      }

      :host(:not(.caught)) svg * {
        fill: #888 !important;
      }

      svg {
        flex: 1;
        height: 100%;
        top: 0;
        left: 0;
      }
    </style>
  </template>
  <script>
    (() => {
      const images = {};

      Polymer({
        is: 'polymon-portrait',

        properties: {
          polymon: {
            type: Object,
            observer: '__applyPolymonImage'
          },

          caught: {
            type: Boolean,
            value: false,
            observer: '__caughtChanged'
          }
        },

        get imageCache() {
          return images;
        },

        __allocateImage: function() {
          let shortName = this.polymon.shortName;

          if (images[shortName] && images[shortName].length) {
            return images[shortName].pop();
          }

          let icon = Polymer.DomModule
              .import('polymon-iconset', `#${shortName}`);

          if (icon) {
            return icon.cloneNode(true);
          }
        },

        __freeImage: function(icon) {
          let shortName = icon.id;

          if (!images[shortName]) {
            images[shortName] = [];
          }

          images[shortName].push(icon);
        },

        __applyPolymonImage: function(polymon) {
          if (this.__icon) {
            Polymer.dom(this.root).removeChild(this.__icon);
            this.__freeImage(this.__icon);
          }

          if (!polymon) {
            return;
          }

          this.__icon = this.__allocateImage();

          if (this.__icon) {
            Polymer.dom(this.root).appendChild(this.__icon);
          }
        },

        __polymonUrl: function(polymon) {
          if (polymon) {
            return `../../images/polymon/${polymon.shortName}.svg`;
          }
        },

        __caughtChanged: function() {
          if (this.caught) {
            this.classList.add('caught');
          } else {
            this.classList.remove('caught');
          }
        }
      });
    })();

  </script>
</dom-module>

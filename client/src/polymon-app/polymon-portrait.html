<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<dom-module id="polymon-portrait">
  <template>
    <style>
      :host {
        display: block;
        border-radius: 32px;
        margin: 4px;
        background-color: var(--polymon-portrait-background, #1ce8b5);
      }

      #image {
        width: 100%;
        height: 100%;
        background-image: url(/images/polymon_sprite_sheet.svg);
        background-repeat: no-repeat;
        transform-origin: 0 0;
      }

      #video {
        width: 100%;
        height: 100%;
        transform: scale(1.3);
        pointer-events: none;
      }

      :host(:not(.animated)) #video {
        display: none;
      }

      :host(.animated) #image {
        background-image: none !important;
      }
    </style>
    <div id="image">
      <content></content>
    </div>
  </template>
  <script>
    Polymer({
      is: 'polymon-portrait',

      properties: {
        animated: {
          type: Boolean,
          value: false
        },

        polymon: {
          type: Object,
          observer: '__applyPolymonImage'
        },

        caught: {
          type: Boolean,
          value: false,
          observer: '__caughtChanged'
        },

        size: {
          type: Number,
          value: 64
        }
      },

      observers: [
        '__applyPolymonImage(polymon, caught, size)'
      ],

      __applyPolymonImage: function(polymon) {
        this.debounce('apply-polymon-image', () => {
          let polymon = this.polymon;
          let index = polymon && polymon.spriteIndex;
          let size = this.size;

          if (index == null) {
            index = -1;
          }

          this.style.width = `${size}px`;
          this.style.height = `${size}px`;
          this.style.borderRadius = `${size / 2}px`;

          if (this.caught) {
            this.$.image.style.backgroundSize = '100%';
            this.$.image.style.backgroundPosition = 'top left';
            this.$.image.style.backgroundImage = `url(/images/polymon_monster_${index}.png)`;
          } else {
            let top = Math.floor(index / 20) * -size;
            let left = (index % 20) * -size;

            this.$.image.style.backgroundSize = `${size * 20}px ${size * 20}px`;
            this.$.image.style.backgroundPosition = `${left}px ${top}px`;
            this.$.image.style.backgroundImage = '';
          }

          if (polymon && polymon.animated && this.animated && index === 28) {
            if (this.__video == null) {
              const video = document.createElement('video');
              video.id = 'video';
              video.autoplay = true;
              video.loop = true;
              video.muted = true;

              const image = Polymer.dom(this.$.image);
              image.insertBefore(video, image.firstElementChild);

              this.__video = video;
            }

            this.classList.add('animated');
            this.__video.src = this.resolveUrl(`../../video/polymon_monster_${index}.webm`);
          } else {
            this.classList.remove('animated');
          }
        });
      },

      __caughtChanged: function() {
        if (this.caught) {
          this.classList.add('caught');
        } else {
          this.classList.remove('caught');
        }
      }
    });

  </script>
</dom-module>

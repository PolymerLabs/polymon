<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-query.html">
<link rel="import" href="polymon-portrait.html">
<link rel="import" href="polymon-button.html">
<link rel="import" href="polymon-element.html">
<dom-module id="polymon-polydex">
  <template>
    <style>
      :host {
        position: absolute;
        box-sizing: border-box;
        font-family: var(--polymon-font-family);
        top: 8px;
        left: 8px;
        right: 8px;
        bottom: 8px;
        padding: 8px;

        border-radius: 8px;
        border: 2px solid #999999;
        background-color: #eee;

        @apply --layout-vertical;
        align-items: stretch;

        text-align: center;
        opacity: 0;
        pointer-events: none;
        transform: translateY(10px);
        transition: transform 0.3s, opacity 0.15s;
      }

      :host:after {
        content: '';
        position: absolute;
        box-sizing: border-box;
        pointer-events: none;
        border-radius: 6px;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border: 2px solid #fff;
      }

      :host([active]) {
        opacity: 1;
        pointer-events: all;
        transform: translateY(0);
      }

      #controls {
        @apply --layout-horizontal;
      }

      #controls > :first-child {
        margin-right: 8px;
      }

      #controls > :last-child {
        flex: 1;
      }

      polymon-button {
        width: 100%;
      }

      h2 {
        font-size: 1em;
        color: #444;
        text-align: left;
        margin: 8px 16px 0;
      }

      #team {
        @apply --layout-horizontal;
        justify-content: space-around;
        flex-wrap: wrap;
        border-bottom: 2px solid #ddd;
        padding-bottom: 16px;
        margin: 8px;
      }

      #caught {
        @apply --layout-horizontal;
        flex-wrap: wrap;
        justify-content: center;
        align-content: flex-start;
        flex: 1;
        margin: 8px;
        overflow: auto;
      }

      @media (min-width: 500px) {
        #team {
          justify-content: flex-start;
        }

        .polymon-portrait {
          margin: 8px;
        }
      }
    </style>

    <app-route
        pattern="/show/:polymon"
        route="{{route}}"
        active="{{showPolymonRouteActive}}">
    </app-route>

    <iron-ajax
        url="polymon.json"
        handle-as="json"
        last-response="{{availablePolymons}}"
        auto>
    </iron-ajax>

    <firebase-query
        app-name="polymon"
        path="[[__firebaseTeamPath(user)]]"
        order-by-child="position"
        data="{{team}}">
    </firebase-query>

    <firebase-query
        id="polydexQuery"
        app-name="polymon"
        path="[[__firebasePolydexPath(user)]]"
        data="{{data}}">
    </firebase-query>

    <h2>Your team</h2>
    <section id="team">
      <polymon-portrait polymon="[[team.0.shortName]]" caught></polymon-portrait>
      <polymon-portrait polymon="[[team.1.shortName]]" caught></polymon-portrait>
      <polymon-portrait polymon="[[team.2.shortName]]" caught></polymon-portrait>
      <polymon-portrait polymon="[[team.3.shortName]]" caught></polymon-portrait>
      <polymon-portrait polymon="[[team.4.shortName]]" caught></polymon-portrait>
    </section>
    <h2>Available Polymon</h2>
    <section id="caught">
      <template is="dom-repeat" items="[[entries]]" as="polymon">
        <a href="[[route.prefix]]/show/[[polymon.shortName]]">
          <polymon-portrait
              polymon="[[polymon.shortName]]" caught=[[polymon.caught]]>
          </polymon-portrait>
        </a>
      </template>
    </section>
    <section id="controls">
      <a href="/">
        <polymon-button class="alt">Back</polymon-button>
      </a>
      <a href="/battle">
        <polymon-button>Battle</polymon-button>
      </a>
    </section>
  </template>
  <script>
    Polymer({
      is: 'polymon-polydex',

      behaviors: [
        PolymonElement
      ],

      properties: {
        data: {
          type: Array
        },

        entries: {
          type: Object,
          notify: true,
          readOnly: true
          // computed: '__computePolydexEntries(availablePolymons, data.length)'
        },

        availablePolymons: {
          type: Array
        },

        db: {
          type: Object
        }
      },

      observers: [
        '__dataChanged(data.*)',
        '__updateEntries(availablePolymons, data.length)'
      ],

      __dataChanged: function(change) {
        let splices = change.value.indexSplices;

        if (!splices) {
          return;
        }

        let queue = Promise.resolve();
        let db = this.$.polydexQuery.db;

        splices.forEach(splice => {
          for (let i = 0; i < splice.addedCount; ++i) {
            let polydexEntry = splice.object[splice.index + i];

            queue = queue
                .then(() => this.__polymonById(polydexEntry.polymonId))
                .then(polymon => this.fire('polydex-entry-added', {
                  polymon,
                  polydexEntry
                }));
          }
        });
      },

      __polymonById: function(polymonId) {
        return this.$.polydexQuery.db
            .ref(`/polymons/${polymonId}`)
            .once('value')
            .then(snapshot => snapshot.val());
      },

      __updateEntries: function(availablePolymons) {
        Promise.all(this.data.map(
            polydexEntry => this.__polymonById(polydexEntry.polymonId)))
            .then(caughtPolymons => {
              let entries = availablePolymons.map(polymon => {
                let caught = false;

                for (let i = 0; i < caughtPolymons.length; ++i) {
                  if (caughtPolymons[i].shortName === polymon.shortName) {
                    caught = true;
                    caughtPolymons.splice(i, 1);
                    break;
                  }
                }

                return Object.assign({}, { caught }, polymon);
              });

              this._setEntries(entries);
            });
      },

      __computePolydexEntries: function(availablePolymons) {
        let remainingData = this.data.slice();

        return availablePolymons.map(polymon => {
          let caught = false;
          let shortName = polymon.shortName;

          for (let i = 0; i < remainingData.length; ++i) {
            let polymonId = remainingData[i].polymonId;

            if (remainingData[i].shortName === shortName) {
              remainingData.splice(i, 1);
              caught = true;
              break;
            }
          }

          return { shortName, caught };
        });
      },

      __firebasePolydexPath: function(user) {
        return user == null ? null : `/users/${user.uid}/polydex`;
      },

      __firebaseTeamPath: function(user) {
        return user == null ? null : `/users/${user.uid}/team`;
      }
    });
  </script>
</dom-module>

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/polymerfire/firebase.html">
<link rel="import" href="polymon-element.html">

<dom-module id="polymon-coded-url-handler">
  <template>
    <!-- NOTE(cdata): This is a special route that
         may never correspond to an actual view. It
         is used as an endpoint that QR codes and
         beacons can point to -->
    <app-route
        pattern="/code/:data"
        route="{{route}}"
        data="{{codeRouteData}}"
        active="{{codeRouteActive}}">
    </app-route>
  </template>
  <script>
    Polymer({
      is: 'polymon-coded-url-handler',

      behaviors: [PolymonElement],

      properties: {
        authenticated: {
          type: Boolean
        },

        authStatusKnown: {
          type: Boolean
        },

        codeQueue: {
          type: Array,
          value: function() {
            return [];
          }
        },

        codeRouteData: {
          type: Object,
          notify: true
        }
      },

      observers: [
        '__codeQueueChanged(codeQueue.length, authStatusKnown)',
        '__codeRouteDataChanged(codeRouteData.*, codeRouteActive)'
      ],

      attached: function() {
        this.__ownerRoot = Polymer.dom(this).getOwnerRoot() || document;
        this.listen(this.__ownerRoot, 'polymon-code', '__onPolymonCode');
      },

      detached: function() {
        this.unlisten(this.__ownerRoot, 'polymon-code', '__onPolymonCode');
      },

      pushPolymonCode: function(data) {
        this.push('codeQueue', data);
        this.__flushCodeQueue();
      },

      __flushCodeQueue: function() {
        this.deraf('flush-code-queue', () => {
          if (!this.authenticated) {
            return;
          }

          while (this.codeQueue.length) {
            this.__handleCode(this.shift('codeQueue'));
          }
        });
      },

      __handleCode: function(data) {
        let { type, code } = data;

        switch (type) {
          // A reference is a secret code that points to a Polymon in the
          // the database. When a reference is scanned, we attempt to catch
          // the Polymon by pushing the details on to the user's catch queue.
          case 'reference':
            let catchData = { code };

            if (this.playerLatLng) {
              catchData.latLng = this.playerLatLng;
            }

            let catchId = firebase.app('polymon').database()
                .ref(`/users/${this.user.uid}/catchQueue`)
                .push(catchData).key;

            this.fire('polymon-catch', { catchId });
          break;
          // A battle code is typically shared from one user to another when one
          // user starts a battle and the other user scans the code on her
          // screen.
          case 'battle':
            firebase.app('polymon').database()
                .ref(`/users/${this.user.uid}/battleQueue`).push({
                  action: 'join',
                  battleId: code,
                  createdAt: Date.now()
                });
          break;
        }
      },

      __codeQueueChanged: function() {
        if (!this.authStatusKnown) {
          // This handler will be called again when auth status is known.
          return;
        }

        if (this.authenticated) {
          this.__flushCodeQueue();
        } else {
          // TODO(cdata): Use this condition to show user an intro message
          // about Polymon and calling them to sign in to claim their catch..
        }
      },

      __onPolymonCode: function(event) {
        this.pushPolymonCode(event.detail);

        if (event.detail.confirmCallback != null) {
          event.detail.confirmCallback();
        }
      },

      __codeRouteDataChanged: function() {
        if (this.codeRouteData && this.codeRouteData.data) {
          let { data } = this.codeRouteData;
          let [ type, code ] = data.split('.');

          this.pushPolymonCode({ type, code });
        }

        if (this.codeRouteActive) {
          // Return to the parent path right away..
          this.set('route.path', this.route.prefix);
        }
      }
    });
  </script>
</dom-module>
